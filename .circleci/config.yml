version: 2.1

commands:
  run_sonar_scan:
    description: "Install sonar-scanner and run analysis"
    parameters:
      workdir:
        type: string
      project_key:
        type: string
    steps:
      - run:
          name: Install sonar-scanner
          command: |
            SCANNER_VERSION=5.0.1.3006
            curl -sSLo scanner.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SCANNER_VERSION}-linux.zip"
            sudo apt-get update && sudo apt-get install -y unzip >/dev/null
            unzip -q scanner.zip
            echo 'export PATH="$PWD/sonar-scanner-'${SCANNER_VERSION}'-linux/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Sonar scan (<< parameters.workdir >>)
          command: |
            cd << parameters.workdir >>
            sonar-scanner \
              -Dsonar.projectKey="<< parameters.project_key >>" \
              -Dsonar.host.url="${SONAR_HOST_URL:-https://sonarcloud.io}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.organization="st10300512" \
              -Dsonar.qualitygate.wait=true

jobs:
  scan_backend:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout
      - run:
          name: Install backend deps
          command: |
            cd international-payment-portal-backend
            if [ -f package-lock.json ]; then npm ci || npm install --no-audit --no-fund; else npm install --no-audit --no-fund; fi
      - run_sonar_scan:
          workdir: "international-payment-portal-backend"
          project_key: "insy7314_backend"

  scan_frontend:
    docker:
      - image: cimg/node:20.11
    steps:
      - checkout
      - run:
          name: Install UI deps
          command: |
            cd international-payment-portal-ui
            if [ -f package-lock.json ]; then npm ci || npm install --no-audit --no-fund; else npm install --no-audit --no-fund; fi
      - run_sonar_scan:
          workdir: "international-payment-portal-ui"
          project_key: "insy7314_ui"

workflows:
  version: 2
  sonar_pipeline:
    jobs:
      - scan_backend
      - scan_frontend
